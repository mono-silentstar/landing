# MONO LANDING — IMPLEMENTATION DOC

Reference: `DESIGN.md` for all visual/interaction decisions.
This document covers **how** to build it.

---

## Build Order

### Phase 1: Static Book
Get the book looking right with hardcoded content. No interactions.
1. `index.php` — HTML shell with full DOM structure
2. `style.css` — perspective, book, leather, spine, pages, gold details
3. Hardcoded cover spread (bookplate + TOC) as initial content
4. Desk surface background
5. **Checkpoint:** The book sits there, at 45deg, looking like a book.

### Phase 2: Theming
6. CSS custom properties for all colors/dimensions
7. `.dark` class overrides
8. Toggle button (HTML + CSS + JS)
9. `prefers-color-scheme` detection + `localStorage`
10. Theme transition (`0.8s ease` on all color properties)
11. Toggle icon animation (sun/moon rotate + crossfade)
12. **Checkpoint:** Toggle works, colors shift smoothly.

### Phase 3: Page Turns
13. Spread PHP partials (cover, about, cv, diss)
14. Turn zone click handlers
15. Phantom page animation (JS creates clone, animates, removes)
16. HTMX spread swap (fetch partial, inject during animation)
17. Keyboard arrow key support
18. Position indicator dots
19. TOC entry click → jump to spread
20. Edge behavior (disable turn at first/last spread)
21. **Checkpoint:** You can browse all spreads with animation.

### Phase 4: Zoom Transition
22. Detail PHP partials (about, cv, diss)
23. Click zone handlers (content area, not turn zones)
24. Zoom animation (CSS classes toggled by JS)
25. HTMX detail content loading
26. Detail view layout and styling
27. Back button (in-page + browser history)
28. `.htaccess` + PHP routing for direct URLs
29. **Checkpoint:** Click spread → zoom in → read → back → book.

### Phase 5: Polish
30. Parallax on mouse move
31. Drag-to-turn interaction
32. Hover states (turn zones, spreads, TOC, toggle, dots)
33. Cursor styles per zone
34. Page load fade-in animation
35. `prefers-reduced-motion` fallbacks
36. **Checkpoint:** Everything feels polished and responsive.

### Phase 6: Mobile
37. Flipbook layout (CSS media query restructure)
38. Touch swipe handling (up/down)
39. Flipbook page flip animation
40. Mobile zoom transition
41. Responsive scaling for tablet
42. **Checkpoint:** Works on all screen sizes.

---

## DOM Structure

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mono</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/htmx.org@2.0.4" defer></script>
</head>
<body>

    <!-- Dark/Light Toggle — always visible, above everything -->
    <button class="theme-toggle" role="switch" aria-checked="false"
            aria-label="Dark mode" id="theme-toggle">
        <span class="theme-toggle__icon theme-toggle__icon--sun">
            <!-- inline SVG sun -->
        </span>
        <span class="theme-toggle__icon theme-toggle__icon--moon">
            <!-- inline SVG moon -->
        </span>
    </button>

    <!-- Book View -->
    <div class="scene" id="scene">
        <div class="book" id="book">
            <div class="book__cover">

                <!-- Spread content — this entire div gets swapped by HTMX -->
                <div class="book__spread" id="spread-content">
                    <!-- Two pages, injected by PHP or HTMX -->
                    <!-- See "Spread Partial Format" below -->
                </div>

                <!-- Spine — absolutely positioned, visual only -->
                <div class="book__spine"></div>

            </div>
        </div>

        <!-- Book shadow on desk — pseudo-element on .scene -->

        <!-- Position indicator dots -->
        <nav class="spread-dots" id="spread-dots" role="tablist"
             aria-label="Page navigation">
            <!-- Generated by JS based on spread count -->
        </nav>
    </div>

    <!-- Detail View — hidden by default, overlays book when active -->
    <div class="detail" id="detail-view" role="main" aria-hidden="true">
        <a href="/" class="detail__back" id="detail-back">
            ← Back to book
        </a>
        <div class="detail__page">
            <div class="detail__content" id="detail-content">
                <!-- Detail content loaded by HTMX -->
            </div>
        </div>
    </div>

    <script src="/js/book.js"></script>
</body>
</html>
```

### Key DOM Notes

- **`.book__spread`** is the HTMX swap target for page turns. Contains
  both pages. The spine is a sibling, not inside the spread, so it
  stays put during swaps.
- **`.book__spine`** is `position: absolute`, centered over the gap
  between pages. Purely visual.
- **`.detail`** is a sibling of `.scene`, not nested inside it. When
  active, it overlays the scene via z-index and the zoom animation.
- **Turn zones** live inside each page (see spread partial format).
  They're absolutely positioned strips on the outer edge of each page.

---

## Spread Partial Format

Every spread partial outputs this structure:

```html
<!-- Example: partials/spreads/about.php -->
<div class="book__page book__page--left">
    <div class="turn-zone turn-zone--prev"
         role="button" tabindex="0" aria-label="Previous page">
    </div>
    <div class="page-content" data-spread="about" data-detail="/detail/about">
        <!-- Left page content here -->
        <h2 class="page-title">About</h2>
        <p>...</p>
    </div>
</div>
<div class="book__page book__page--right">
    <div class="page-content" data-spread="about" data-detail="/detail/about">
        <!-- Right page content here -->
        <h2 class="page-title">Skills & Interests</h2>
        <p>...</p>
    </div>
    <div class="turn-zone turn-zone--next"
         role="button" tabindex="0" aria-label="Next page">
    </div>
</div>
```

### Data Attributes
- `data-spread="name"` — identifies which spread this is (for JS state)
- `data-detail="/detail/about"` — the HTMX URL to fetch the detail view.
  Present on spreads 1+, absent on spread 0 (front matter is not zoomable).

### Cover Spread Special Case

```html
<!-- partials/spreads/cover.php -->
<div class="book__page book__page--left">
    <!-- No prev turn zone on spread 0 -->
    <div class="page-content page-content--bookplate" data-spread="cover">
        <div class="bookplate">
            <span class="bookplate__label">EX LIBRIS</span>
            <h1 class="bookplate__name">Mono</h1>
            <hr class="gold-rule">
        </div>
    </div>
</div>
<div class="book__page book__page--right">
    <div class="page-content page-content--toc" data-spread="cover">
        <h2 class="page-title">Contents</h2>
        <ul class="toc">
            <li class="toc__entry" data-goto-spread="1">
                <span class="toc__title">About</span>
                <span class="toc__dots"></span>
                <span class="toc__number">I</span>
            </li>
            <li class="toc__entry" data-goto-spread="2">
                <span class="toc__title">Curriculum Vitae</span>
                <span class="toc__dots"></span>
                <span class="toc__number">II</span>
            </li>
            <li class="toc__entry" data-goto-spread="3">
                <span class="toc__title">Dissertation</span>
                <span class="toc__dots"></span>
                <span class="toc__number">III</span>
            </li>
        </ul>
    </div>
    <div class="turn-zone turn-zone--next"
         role="button" tabindex="0" aria-label="Next page">
    </div>
</div>
```

---

## Detail Partial Format

```html
<!-- Example: partials/details/about.php -->
<article>
    <h1 class="detail__title">About</h1>
    <section>
        <!-- Full about content -->
    </section>
</article>
```

Detail partials are simple semantic HTML. All styling comes from
`.detail__content` parent styles in CSS.

---

## CSS Architecture

### Custom Properties

All tweakable values live as custom properties on `:root`:

```css
:root {
    /* --- Colors (Light Mode) --- */
    --bg:            #c4a882;
    --bg-center:     #d4b892;
    --page:          #f5ecd7;
    --leather:       #5c3a21;
    --gold:          #b8960c;
    --spine:         #4a2e18;
    --text-title:    #2c1810;
    --text-body:     #3d2b1f;
    --text-subtle:   #6b5344;
    --shadow-page:   rgba(60, 30, 10, 0.15);
    --shadow-desk:   rgba(40, 20, 5, 0.3);
    --text-glow:     none;
    --toggle-bg:     rgba(0, 0, 0, 0.1);

    /* --- Dimensions --- */
    --page-width:    370px;
    --page-height:   500px;
    --spine-width:   40px;
    --leather-border: 12px;
    --page-padding:  32px;
    --turn-zone-width: 40px;
    --gold-inset:    4px;
    --corner-size:   16px;
    --dot-size:      6px;
    --dot-gap:       12px;

    /* --- Perspective --- */
    --perspective:   1200px;
    --book-angle:    45deg;
    --persp-origin-y: 40%;

    /* --- Animation --- */
    --turn-speed:    0.5s;
    --zoom-speed:    0.55s;
    --theme-speed:   0.8s;
    --parallax-smooth: 0.3s;
    --hover-speed:   0.2s;
}

html.dark {
    --bg:            #1a1a2e;
    --bg-center:     #222240;
    --page:          #2a2a3a;
    --leather:       #3a2518;
    --gold:          #d4b856;
    --spine:         #2a1a10;
    --text-title:    #e8e0cc;
    --text-body:     #c8c0b0;
    --text-subtle:   #8a8278;
    --shadow-page:   rgba(0, 0, 20, 0.3);
    --shadow-desk:   rgba(0, 0, 10, 0.5);
    --text-glow:     0 0 8px rgba(232, 224, 204, 0.3);
    --toggle-bg:     rgba(255, 255, 255, 0.1);
}
```

### CSS File Organization (single file, ordered sections)

```
1.  Reset & base styles
2.  Custom properties (above)
3.  Typography (font imports already in <head>)
4.  Body / desk surface
5.  Scene (perspective container)
6.  Book cover (leather frame)
7.  Book spine
8.  Book pages
9.  Gold details (inset border, corners, rules)
10. Page content typography
11. Bookplate styles
12. TOC styles
13. Turn zones
14. Position dots
15. Detail view
16. Theme toggle button
17. Page turn animation (@keyframes + classes)
18. Zoom animation (@keyframes + classes)
19. Page load animation
20. Hover states
21. Reduced motion overrides
22. Tablet media query (≤768px)
23. Mobile media query (≤480px) — flipbook
```

### Key CSS Patterns

**The perspective scene:**
```css
.scene {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding-top: 10vh;
    perspective: var(--perspective);
    perspective-origin: center var(--persp-origin-y);
}
```

**The book transform:**
```css
.book {
    transform: rotateX(var(--book-angle));
    transform-style: preserve-3d;
    transition: transform var(--parallax-smooth) ease-out;
}
```

**The leather cover:**
```css
.book__cover {
    position: relative;
    display: flex;
    padding: var(--leather-border);
    background: var(--leather);
    /* subtle gradient for curvature */
    background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--leather), white 5%) 0%,
        var(--leather) 50%,
        color-mix(in srgb, var(--leather), black 8%) 100%
    );
    border-radius: 4px;
    transition: background var(--theme-speed) ease;
}
```

**Gold inset border on pages (pseudo-element):**
```css
.book__page::before {
    content: '';
    position: absolute;
    inset: var(--gold-inset);
    border: 1px solid var(--gold);
    pointer-events: none;
    transition: border-color var(--theme-speed) ease;
}
```

**Gold corner marks (pseudo-elements on .page-content):**
```css
.page-content::before,
.page-content::after {
    content: '';
    position: absolute;
    width: var(--corner-size);
    height: var(--corner-size);
    border-color: var(--gold);
    border-style: solid;
    border-width: 0;
    transition: border-color var(--theme-speed) ease;
}
/* Top-left corner */
.page-content::before {
    top: calc(var(--gold-inset) + 4px);
    left: calc(var(--gold-inset) + 4px);
    border-top-width: 1px;
    border-left-width: 1px;
}
/* Bottom-right corner */
.page-content::after {
    bottom: calc(var(--gold-inset) + 4px);
    right: calc(var(--gold-inset) + 4px);
    border-bottom-width: 1px;
    border-right-width: 1px;
}
```
(The other two corners use pseudo-elements on the turn zones or
an additional wrapper. Or: just do top-left and bottom-right per
page — four visible corners total across the spread. Simpler.)

**Theme transition on elements (not on :root):**
```css
.book__page,
.book__cover,
.book__spine,
.page-content,
.scene,
.detail,
.detail__page {
    transition:
        background var(--theme-speed) ease,
        color var(--theme-speed) ease,
        box-shadow var(--theme-speed) ease;
}
```

---

## JavaScript Architecture

Single file: `book.js`. No modules, no build step. IIFE to avoid
global scope pollution.

```javascript
(function() {
    'use strict';

    /* ===========================
       CONFIGURATION
       =========================== */

    const CONFIG = {
        // Spreads in order — must match partial filenames
        spreads: ['cover', 'about', 'cv', 'diss'],

        // Which spreads have detail views (by index)
        detailSpreads: { 1: 'about', 2: 'cv', 3: 'diss' },

        // Animation
        turnDuration: 500,    // ms, matches CSS --turn-speed
        zoomDuration: 550,    // ms, matches CSS --zoom-speed
        dragThreshold: 60,    // px to commit a page turn
        dragFeedbackMax: 20,  // px max translateX during drag

        // Parallax
        parallaxX: 4,         // px max shift
        parallaxY: 3,         // px max shift
        parallaxAngle: 1.5,   // deg max rotation adjustment
    };

    /* ===========================
       STATE
       =========================== */

    let state = {
        currentSpread: 0,
        totalSpreads: CONFIG.spreads.length,
        isAnimating: false,    // true during page turn or zoom
        isDetailView: false,   // true when zoomed into detail
        isDragging: false,
        dragStartX: 0,
        dragCurrentX: 0,
        reducedMotion: false,
        isTouchDevice: false,
    };

    /* ===========================
       INITIALIZATION
       =========================== */

    function init() { ... }

    /* ===========================
       THEME TOGGLE
       =========================== */

    function initTheme() { ... }
    function toggleTheme() { ... }
    function applyTheme(dark) { ... }

    /* ===========================
       PAGE TURNS
       =========================== */

    function turnTo(spreadIndex) { ... }
    function turnForward() { ... }
    function turnBackward() { ... }
    function animatePageTurn(direction, callback) { ... }
    function createPhantomPage(direction) { ... }
    function loadSpread(name, callback) { ... }
    function updateDots() { ... }
    function updateTurnZones() { ... }

    /* ===========================
       ZOOM (BOOK ↔ DETAIL)
       =========================== */

    function zoomIn(detailUrl) { ... }
    function zoomOut() { ... }
    function loadDetail(url, callback) { ... }

    /* ===========================
       DRAG HANDLING
       =========================== */

    function initDrag() { ... }
    function onDragStart(x) { ... }
    function onDragMove(x) { ... }
    function onDragEnd() { ... }

    /* ===========================
       PARALLAX
       =========================== */

    function initParallax() { ... }
    function updateParallax(mouseX, mouseY) { ... }

    /* ===========================
       MOBILE / FLIPBOOK
       =========================== */

    function initMobile() { ... }
    function onSwipe(direction) { ... }

    /* ===========================
       KEYBOARD
       =========================== */

    function initKeyboard() { ... }

    /* ===========================
       BOOT
       =========================== */

    document.addEventListener('DOMContentLoaded', init);

})();
```

### Key JS Implementation Details

**Theme Toggle:**
```javascript
function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved) {
        applyTheme(saved === 'dark');
    } else {
        applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches);
    }

    document.getElementById('theme-toggle')
        .addEventListener('click', toggleTheme);
}

function applyTheme(dark) {
    document.documentElement.classList.toggle('dark', dark);
    const toggle = document.getElementById('theme-toggle');
    toggle.setAttribute('aria-checked', dark);
    localStorage.setItem('theme', dark ? 'dark' : 'light');
}
```

**Phantom Page Turn (forward):**
```javascript
function animatePageTurn(direction, callback) {
    if (state.isAnimating) return;
    state.isAnimating = true;

    const spread = document.getElementById('spread-content');
    const sourcePage = direction === 'forward'
        ? spread.querySelector('.book__page--right')
        : spread.querySelector('.book__page--left');

    // 1. Clone the page as a phantom
    const phantom = sourcePage.cloneNode(true);
    phantom.classList.add('phantom-page');
    phantom.classList.add(direction === 'forward'
        ? 'phantom-page--forward'
        : 'phantom-page--backward');

    // Position phantom exactly over the source page
    const rect = sourcePage.getBoundingClientRect();
    // (phantom is absolutely positioned within .book__cover)
    spread.parentElement.appendChild(phantom);

    // 2. Start the animation
    requestAnimationFrame(() => {
        phantom.classList.add('phantom-page--animating');
    });

    // 3. At midpoint, swap the real content underneath
    setTimeout(() => {
        callback(); // This triggers HTMX content swap
    }, CONFIG.turnDuration / 2);

    // 4. Remove phantom when animation completes
    setTimeout(() => {
        phantom.remove();
        state.isAnimating = false;
    }, CONFIG.turnDuration);
}
```

**Phantom page CSS:**
```css
.phantom-page {
    position: absolute;
    top: var(--leather-border);
    width: var(--page-width);
    height: var(--page-height);
    background: var(--page);
    backface-visibility: hidden;
    z-index: 15;
    pointer-events: none;
}

.phantom-page--forward {
    right: var(--leather-border);
    transform-origin: left center;
}

.phantom-page--backward {
    left: var(--leather-border);
    transform-origin: right center;
}

.phantom-page--animating.phantom-page--forward {
    animation: page-turn-forward var(--turn-speed) ease-in-out forwards;
}

.phantom-page--animating.phantom-page--backward {
    animation: page-turn-backward var(--turn-speed) ease-in-out forwards;
}

@keyframes page-turn-forward {
    0%   { transform: rotateY(0deg)    translateZ(0);    }
    15%  { transform: rotateY(0deg)    translateZ(10px); }
    85%  { transform: rotateY(-180deg) translateZ(10px); }
    100% { transform: rotateY(-180deg) translateZ(0);    }
}

@keyframes page-turn-backward {
    0%   { transform: rotateY(0deg)   translateZ(0);    }
    15%  { transform: rotateY(0deg)   translateZ(10px); }
    85%  { transform: rotateY(180deg) translateZ(10px); }
    100% { transform: rotateY(180deg) translateZ(0);    }
}
```

**Zoom Transition:**
```javascript
function zoomIn(detailUrl) {
    if (state.isAnimating || state.isDetailView) return;
    state.isAnimating = true;

    const book = document.getElementById('book');
    const detail = document.getElementById('detail-view');
    const scene = document.getElementById('scene');

    // Start zoom animation via class
    scene.classList.add('scene--zooming-in');

    // Fetch detail content in parallel
    htmx.ajax('GET', detailUrl, {
        target: '#detail-content',
        swap: 'innerHTML'
    });

    // After animation completes, show detail view
    setTimeout(() => {
        scene.classList.remove('scene--zooming-in');
        scene.classList.add('scene--detail-active');
        detail.setAttribute('aria-hidden', 'false');
        state.isDetailView = true;
        state.isAnimating = false;

        // Update URL
        history.pushState(
            { view: 'detail', spread: state.currentSpread },
            '',
            '/' + CONFIG.detailSpreads[state.currentSpread]
        );
    }, CONFIG.zoomDuration);
}
```

**Zoom CSS:**
```css
/* Zooming in: book scales up, flattens, fades */
.scene--zooming-in .book {
    animation: zoom-in var(--zoom-speed) ease-out forwards;
}

@keyframes zoom-in {
    0% {
        transform: rotateX(var(--book-angle)) scale(1);
        opacity: 1;
    }
    70% {
        transform: rotateX(5deg) scale(1.4);
        opacity: 1;
    }
    100% {
        transform: rotateX(0deg) scale(1.5);
        opacity: 0;
    }
}

/* Detail active: book hidden, detail visible */
.scene--detail-active .book {
    opacity: 0;
    pointer-events: none;
}

.scene--detail-active ~ .detail {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}

/* Detail default (hidden) */
.detail {
    position: fixed;
    inset: 0;
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    overflow-y: auto;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
```

**Drag Handling:**
```javascript
function initDrag() {
    const book = document.getElementById('book');
    let suppressClick = false;

    book.addEventListener('mousedown', (e) => {
        if (state.isAnimating || state.isDetailView) return;
        state.isDragging = true;
        state.dragStartX = e.clientX;
        state.dragCurrentX = e.clientX;
        suppressClick = false;
    });

    window.addEventListener('mousemove', (e) => {
        if (!state.isDragging) return;
        state.dragCurrentX = e.clientX;
        const dx = state.dragCurrentX - state.dragStartX;
        const clamped = Math.max(-CONFIG.dragFeedbackMax,
                        Math.min(CONFIG.dragFeedbackMax, dx));
        // Apply visual feedback
        document.getElementById('spread-content')
            .style.transform = `translateX(${clamped}px)`;
        if (Math.abs(dx) > 5) suppressClick = true;
    });

    window.addEventListener('mouseup', () => {
        if (!state.isDragging) return;
        state.isDragging = false;
        const dx = state.dragCurrentX - state.dragStartX;
        // Reset visual feedback
        const spread = document.getElementById('spread-content');
        spread.style.transform = '';
        spread.style.transition = `transform var(--hover-speed) ease-out`;
        setTimeout(() => { spread.style.transition = ''; }, 250);

        // Commit or snap back
        if (dx < -CONFIG.dragThreshold) turnForward();
        else if (dx > CONFIG.dragThreshold) turnBackward();
    });

    // Suppress click after drag
    book.addEventListener('click', (e) => {
        if (suppressClick) {
            e.stopPropagation();
            e.preventDefault();
            suppressClick = false;
        }
    }, true); // capture phase to intercept before other handlers
}
```

**Parallax:**
```javascript
function initParallax() {
    if (state.isTouchDevice || state.reducedMotion) return;

    window.addEventListener('mousemove', (e) => {
        if (state.isDetailView) return;
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const dx = (e.clientX - cx) / cx; // -1 to 1
        const dy = (e.clientY - cy) / cy; // -1 to 1

        const book = document.getElementById('book');
        const tx = -dx * CONFIG.parallaxX;
        const ty = -dy * CONFIG.parallaxY;
        const rx = 45 + (dy * CONFIG.parallaxAngle);
        const ry = -dx * CONFIG.parallaxAngle;

        book.style.transform =
            `rotateX(${rx}deg) rotateY(${ry}deg) translate(${tx}px, ${ty}px)`;
    });
}
```

---

## PHP Routing

### `.htaccess`

```apache
RewriteEngine On
RewriteBase /

# Serve existing files and directories directly
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Route everything else through index.php
RewriteRule ^(.*)$ index.php [L,QSA]
```

### `index.php` Routing Logic

```php
<?php
$uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
$uri = rtrim($uri, '/');
if ($uri === '') $uri = '/';

$isHtmx = isset($_SERVER['HTTP_HX_REQUEST']);

// --- HTMX Partial Routes ---
// /spread/{name} → serves a spread partial
// /detail/{name} → serves a detail partial

if ($isHtmx && preg_match('#^/(spread|detail)/(\w+)$#', $uri, $m)) {
    $type = $m[1] === 'spread' ? 'spreads' : 'details';
    $name = $m[2];
    $file = __DIR__ . "/partials/{$type}/{$name}.php";
    if (file_exists($file)) {
        include $file;
    } else {
        http_response_code(404);
        echo 'Not found';
    }
    exit;
}

// --- Full Page Routes ---

$sections = [
    '/'              => ['view' => 'book',   'spread' => 'cover'],
    '/about'         => ['view' => 'detail', 'section' => 'about'],
    '/cv'            => ['view' => 'detail', 'section' => 'cv'],
    '/dissertation'  => ['view' => 'detail', 'section' => 'diss'],
];

$route = $sections[$uri] ?? null;

if (!$route) {
    http_response_code(404);
    echo '404';
    exit;
}

// Variables available to the shell template
$view = $route['view'];
$initialSpread = $route['spread'] ?? 'cover';
$initialDetail = $route['section'] ?? null;
?>
<!-- Shell HTML starts here (the full DOM from above) -->
<!-- PHP conditionals within the shell handle whether to show
     book view or detail view on initial load -->
```

### Conditional Initial Load

In the shell HTML, the initial state depends on the route:

```php
<!-- In the scene section -->
<div class="book__spread" id="spread-content">
    <?php include __DIR__ . "/partials/spreads/{$initialSpread}.php"; ?>
</div>

<!-- In the detail section -->
<div class="detail" id="detail-view" role="main"
     aria-hidden="<?= $view === 'book' ? 'true' : 'false' ?>"
     class="detail <?= $view === 'detail' ? 'detail--active' : '' ?>">
    <?php if ($view === 'detail' && $initialDetail): ?>
        <a href="/" class="detail__back" id="detail-back">← Back to book</a>
        <div class="detail__page">
            <div class="detail__content" id="detail-content">
                <?php include __DIR__ . "/partials/details/{$initialDetail}.php"; ?>
            </div>
        </div>
    <?php endif; ?>
</div>
```

When someone visits `/cv` directly, the page loads with the detail
view active and the book hidden. The back button goes to `/`.

---

## HTMX Wiring

### Page Turn (Spread Swap)

Triggered by JS, not by HTMX attributes in HTML. JS calls:

```javascript
function loadSpread(name, callback) {
    htmx.ajax('GET', '/spread/' + name, {
        target: '#spread-content',
        swap: 'innerHTML',
    }).then(() => {
        if (callback) callback();
    });
}
```

This is called from within `animatePageTurn()` at the midpoint.

### Zoom In (Detail Load)

Also triggered by JS:

```javascript
htmx.ajax('GET', '/detail/' + sectionName, {
    target: '#detail-content',
    swap: 'innerHTML',
});
```

### Why JS-Triggered Instead of `hx-` Attributes

The timing of swaps is controlled by animation state. We need to
swap content at specific moments (midpoint of turn, during zoom).
Using `hx-` attributes would trigger swaps on click, which is too
early. JS gives us precise timing control.

HTMX is still doing the fetching/swapping — we're just triggering
it programmatically instead of declaratively.

---

## Mobile Flipbook (≤480px)

### CSS Restructure

```css
@media (max-width: 480px) {
    :root {
        --book-angle: 25deg;
        --page-padding: 20px;
    }

    /* Hide spine */
    .book__spine { display: none; }

    /* Single page layout */
    .book__spread {
        flex-direction: column;
    }

    .book__page--left,
    .book__page--right {
        width: 85vw;
        max-width: 370px;
    }

    /* On mobile, only show the "active" mobile page */
    /* JS manages which page is visible via .mobile-active class */
    .book__page { display: none; }
    .book__page.mobile-active { display: block; }

    /* Lighter appearance — no heavy leather border */
    .book__cover {
        padding: 4px;
        border-radius: 2px;
        background: var(--gold);
    }

    /* Turn zones become top/bottom instead of left/right */
    .turn-zone--prev,
    .turn-zone--next {
        width: 100%;
        height: 40px;
    }
    .turn-zone--prev { top: 0; left: 0; }
    .turn-zone--next { bottom: 0; left: 0; }

    /* Flipbook page turn (vertical) */
    @keyframes flip-up {
        0%   { transform: rotateX(0deg)   translateZ(0); }
        15%  { transform: rotateX(0deg)   translateZ(8px); }
        85%  { transform: rotateX(-180deg) translateZ(8px); }
        100% { transform: rotateX(-180deg) translateZ(0); }
    }
}
```

### JS Mobile Page Mapping

On mobile, the spreads are split into individual pages:

```javascript
const MOBILE_PAGES = [
    { spread: 'cover', side: 'left' },   // Bookplate
    { spread: 'cover', side: 'right' },  // TOC
    { spread: 'about', side: 'both' },   // About (stacked)
    { spread: 'cv',    side: 'both' },   // CV (stacked)
    { spread: 'diss',  side: 'both' },   // Dissertation (stacked)
];
```

For `side: 'both'`, both left and right page content is shown stacked
vertically with a gold divider. CSS handles the stacking:

```css
@media (max-width: 480px) {
    .book__page.mobile-active.mobile-stacked .page-content {
        display: block; /* both pages visible, stacked */
    }
}
```

### Touch Swipe

```javascript
function initMobile() {
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', (e) => {
        const dy = touchStartY - e.changedTouches[0].clientY;
        if (Math.abs(dy) > CONFIG.dragThreshold) {
            if (dy > 0) onSwipe('up');   // next page
            else onSwipe('down');         // prev page
        }
    });
}
```

---

## Accessibility Implementation

### Reduced Motion

```css
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01s !important;
        transition-duration: 0.01s !important;
    }
}
```

JS also checks:
```javascript
state.reducedMotion = window.matchMedia(
    '(prefers-reduced-motion: reduce)'
).matches;
```

When `reducedMotion` is true, phantom page cloning is skipped —
content just swaps instantly.

### No-JS Fallback

```html
<noscript>
    <style>
        .turn-zone,
        .spread-dots,
        .theme-toggle { display: none; }
        /* Make TOC entries regular links */
    </style>
</noscript>
```

TOC entries in `cover.php` are `<a>` tags wrapping the list items,
linking to `/about`, `/cv`, `/dissertation`. They work without JS
as regular navigation.

### Skip Link

```html
<!-- First element in <body> -->
<a href="#spread-content" class="sr-only sr-only--focusable">
    Skip to content
</a>
```

---

## Placeholder Content Plan

### Bookplate
- "EX LIBRIS" + "Mono"
- Gold border, centered, classic

### About Spread (Summary)
- Left: "Designer, developer, maker of things." + 2-3 sentence intro
- Right: Skill list with humor
  - *"Crochet (advanced threat level)"*
  - *"Naming variables on the first try (aspirational)"*
  - *"PHP apologist (unapologetic)"*
  - *"Rollerblading (poorly, but with conviction)"*

### CV Spread (Summary)
- Left: 2-3 most recent roles, title + company + one-liner each
- Right: Education, key skills list (serious this time, with one
  sneaky joke entry)

### Dissertation Spread (Summary)
- Left: Title (placeholder), one-paragraph abstract
- Right: Key findings as bullet points, "Read full paper →" link

### Detail Pages
- Extended versions of the spread content. More depth, more entries,
  still with personality. Full placeholder text that demonstrates
  the layout structure. She swaps in real content later.

---

## Testing Checklist

After each phase, verify:

- [ ] Book renders correctly at 45deg perspective
- [ ] Light/dark mode toggle works, smooth transition
- [ ] Page turns animate correctly (forward + backward)
- [ ] HTMX partials load without flash
- [ ] Zoom in/out works, URL updates, back button works
- [ ] Direct URL access works (`/cv` loads detail view)
- [ ] Parallax feels subtle, not nauseating
- [ ] Drag turns pages, doesn't trigger zoom
- [ ] All hover/cursor states correct
- [ ] Mobile flipbook works (swipe, tap, zoom)
- [ ] Keyboard navigation works (arrows, tab, enter, escape)
- [ ] Reduced motion respected
- [ ] No-JS: TOC links work, content visible
- [ ] Dark mode matches system preference on first load

---

*This is the build plan. Follow the phases in order.
Each phase has a checkpoint — don't move on until it passes.*
